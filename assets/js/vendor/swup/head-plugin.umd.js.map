{"version":3,"file":"index.umd.js","sources":["../node_modules/@swup/plugin/dist/index.modern.js","../src/mergeHeadContents.ts","../src/updateAttributes.ts","../src/waitForAssets.ts","../src/index.ts"],"sourcesContent":["function r(){return r=Object.assign?Object.assign.bind():function(r){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t])}return r},r.apply(this,arguments)}const n=r=>String(r).split(\".\").map(r=>String(parseInt(r||\"0\",10))).concat([\"0\",\"0\"]).slice(0,3).join(\".\");class e{constructor(){this.isSwupPlugin=!0,this.swup=void 0,this.version=void 0,this.requires={},this.handlersToUnregister=[]}mount(){}unmount(){this.handlersToUnregister.forEach(r=>r()),this.handlersToUnregister=[]}_beforeMount(){if(!this.name)throw new Error(\"You must define a name of plugin when creating a class.\")}_afterUnmount(){}_checkRequirements(){return\"object\"!=typeof this.requires||Object.entries(this.requires).forEach(([r,e])=>{if(!function(r,e,t){const s=function(r,n){var e;if(\"swup\"===r)return null!=(e=n.version)?e:\"\";{var t;const e=n.findPlugin(r);return null!=(t=null==e?void 0:e.version)?t:\"\"}}(r,t);return!!s&&((r,e)=>e.every(e=>{const[,t,s]=e.match(/^([\\D]+)?(.*)$/)||[];var o,i;return((r,n)=>{const e={\"\":r=>0===r,\">\":r=>r>0,\">=\":r=>r>=0,\"<\":r=>r<0,\"<=\":r=>r<=0};return(e[n]||e[\"\"])(r)})((i=s,o=n(o=r),i=n(i),o.localeCompare(i,void 0,{numeric:!0})),t||\">=\")}))(s,e)}(r,e=Array.isArray(e)?e:[e],this.swup)){const n=`${r} ${e.join(\", \")}`;throw new Error(`Plugin version mismatch: ${this.name} requires ${n}`)}}),!0}on(r,n,e={}){var t;n=!(t=n).name.startsWith(\"bound \")||t.hasOwnProperty(\"prototype\")?n.bind(this):n;const s=this.swup.hooks.on(r,n,e);return this.handlersToUnregister.push(s),s}once(n,e,t={}){return this.on(n,e,r({},t,{once:!0}))}before(n,e,t={}){return this.on(n,e,r({},t,{before:!0}))}replace(n,e,t={}){return this.on(n,e,r({},t,{replace:!0}))}off(r,n){return this.swup.hooks.off(r,n)}}export{e as default};\n//# sourceMappingURL=index.modern.js.map\n","type ElementCollection = { el: Element; index?: number }[];\n\nexport default function mergeHeadContents(\n\tcurrentHead: HTMLHeadElement,\n\tnewHead: HTMLHeadElement,\n\t{ shouldPersist = () => false }: { shouldPersist?: (el: Element) => boolean } = {}\n) {\n\tconst currentTags = Array.from(currentHead.children);\n\tconst newChildren = Array.from(newHead.children);\n\n\tconst addTags = getTagsToAdd(currentTags, newChildren);\n\tconst removeTags = getTagsToRemove(currentTags, newChildren);\n\n\t// Remove tags in reverse to keep indexes, keep persistant elements\n\tremoveTags\n\t\t.reverse()\n\t\t.filter(({ el }) => shouldManageTag(el))\n\t\t.filter(({ el }) => !shouldPersist(el))\n\t\t.forEach(({ el }) => currentHead.removeChild(el));\n\n\t// Insert tag *after* previous version of itself to preserve JS variable scope and CSS cascade\n\taddTags\n\t\t.filter(({ el }) => shouldManageTag(el))\n\t\t.forEach(({ el, index = 0 }) => {\n\t\t\tcurrentHead.insertBefore(el.cloneNode(true), currentHead.children[index + 1] || null);\n\t\t});\n\n\treturn {\n\t\tremoved: removeTags.map(({ el }) => el),\n\t\tadded: addTags.map(({ el }) => el)\n\t};\n}\n\nfunction getTagsToRemove(currentEls: Element[], newEls: Element[]): ElementCollection {\n\treturn currentEls.reduce((tags, el) => {\n\t\tconst isAmongNew = newEls.some((newEl) => compareTags(el, newEl));\n\t\tif (!isAmongNew) {\n\t\t\ttags.push({ el });\n\t\t}\n\t\treturn tags;\n\t}, [] as ElementCollection);\n}\n\nfunction getTagsToAdd(currentEls: Element[], newEls: Element[]): ElementCollection {\n\treturn newEls.reduce((tags, el, index) => {\n\t\tconst isAmongCurrent = currentEls.some((currentEl) => compareTags(el, currentEl));\n\t\tif (!isAmongCurrent) {\n\t\t\ttags.push({ el, index });\n\t\t}\n\t\treturn tags;\n\t}, [] as ElementCollection);\n}\n\nfunction shouldManageTag(el: Element) {\n\t// Let swup manage the title tag\n\tif (el.localName === 'title') {\n\t\treturn false;\n\t}\n\t// Leave swup theme styles untouched\n\tif (el.matches('[data-swup-theme]')) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n\nfunction compareTags(oldTag: Element, newTag: Element) {\n\treturn oldTag.outerHTML === newTag.outerHTML;\n}\n","export default function updateAttributes(\n\ttarget: Element,\n\tsource: Element,\n\tfilters: (string | RegExp)[] = []\n): void {\n\tconst keep = new Set<string>();\n\n\tfor (const { name, value } of getAttributes(source, filters)) {\n\t\ttarget.setAttribute(name, value);\n\t\tkeep.add(name);\n\t}\n\n\tfor (const { name } of getAttributes(target, filters)) {\n\t\tif (!keep.has(name)) {\n\t\t\ttarget.removeAttribute(name);\n\t\t}\n\t}\n}\n\nfunction getAttributes(el: Element, filters: (string | RegExp)[] = []): Attr[] {\n\tconst all = Array.from(el.attributes);\n\tif (!filters.length) return all;\n\n\treturn all.filter(({ name }) =>\n\t\tfilters.some((pattern) =>\n\t\t\tpattern instanceof RegExp ? pattern.test(name) : name === pattern\n\t\t)\n\t);\n}\n","export default function waitForAssets(\n\telements: Element[],\n\ttimeoutMs: number = 0\n): Promise<HTMLLinkElement>[] {\n\treturn elements.filter(isStylesheet).map((el) => waitForStylesheet(el, timeoutMs));\n}\n\nfunction isStylesheet(el: Element): el is HTMLLinkElement {\n\treturn el.matches('link[rel=stylesheet][href]');\n}\n\nexport function waitForStylesheet(\n\telement: HTMLLinkElement,\n\ttimeoutMs: number = 0\n): Promise<HTMLLinkElement> {\n\tconst whenLoaded = (cb: () => void) => {\n\t\tif (element.sheet) {\n\t\t\tcb();\n\t\t} else {\n\t\t\tsetTimeout(() => whenLoaded(cb), 10);\n\t\t}\n\t};\n\n\treturn new Promise((resolve) => {\n\t\twhenLoaded(() => resolve(element));\n\t\tif (timeoutMs > 0) {\n\t\t\tsetTimeout(() => resolve(element), timeoutMs);\n\t\t}\n\t});\n}\n","import { Handler } from 'swup';\nimport Plugin from '@swup/plugin';\n\nimport mergeHeadContents from './mergeHeadContents.js';\nimport updateAttributes from './updateAttributes.js';\nimport waitForAssets from './waitForAssets.js';\n\ntype Options = {\n\t/** Whether to keep orphaned `link`, `style` and `script` tags from the old page. Default: `false` */\n\tpersistAssets: boolean;\n\t/** Tags that will be persisted when a new page is loaded. Boolean, selector or predicate function. Default: `false` */\n\tpersistTags: boolean | string | ((el: Element) => boolean);\n\t/** Delay the transition to the new page until all newly added assets have finished loading. Default: `false` */\n\tawaitAssets: boolean;\n\t/** Additional attributes of the head element to update. Default: ['lang', 'dir']. */\n\tattributes: (string | RegExp)[];\n\t/** How long to wait for assets before continuing anyway. Only applies if `awaitAssets` is enabled. Default: `3000` */\n\ttimeout: number;\n};\n\nexport default class SwupHeadPlugin extends Plugin {\n\tname = 'SwupHeadPlugin';\n\n\trequires = { swup: '>=4.6' };\n\n\tdefaults: Options = {\n\t\tpersistTags: false,\n\t\tpersistAssets: false,\n\t\tawaitAssets: false,\n\t\tattributes: ['lang', 'dir'],\n\t\ttimeout: 3000\n\t};\n\toptions: Options;\n\n\tconstructor(options: Partial<Options> = {}) {\n\t\tsuper();\n\n\t\tthis.options = { ...this.defaults, ...options };\n\n\t\t// persistAssets is a shortcut for: persistTags with a default asset selector for scripts & styles\n\t\tif (this.options.persistAssets && !this.options.persistTags) {\n\t\t\tthis.options.persistTags = 'link[rel=stylesheet], script[src], style';\n\t\t}\n\t}\n\n\tmount() {\n\t\tthis.before('content:replace', this.updateHead);\n\t}\n\n\tupdateHead: Handler<'content:replace'> = async (visit, { page: { html } }) => {\n\t\tconst { awaitAssets, attributes, timeout } = this.options;\n\n\t\tconst newDocument = visit.to.document!;\n\n\t\tconst { removed, added } = mergeHeadContents(document.head, newDocument.head, {\n\t\t\tshouldPersist: (el) => this.isPersistentTag(el)\n\t\t});\n\n\t\tthis.swup.log(`Removed ${removed.length} / added ${added.length} tags in head`);\n\n\t\tif (attributes?.length) {\n\t\t\tupdateAttributes(document.documentElement, newDocument.documentElement, attributes);\n\t\t}\n\n\t\tif (awaitAssets) {\n\t\t\tconst assetLoadPromises = waitForAssets(added, timeout);\n\t\t\tif (assetLoadPromises.length) {\n\t\t\t\tthis.swup.log(`Waiting for ${assetLoadPromises.length} assets to load`);\n\t\t\t\tawait Promise.all(assetLoadPromises);\n\t\t\t}\n\t\t}\n\t};\n\n\tisPersistentTag(el: Element) {\n\t\tconst { persistTags } = this.options;\n\t\tif (typeof persistTags === 'function') {\n\t\t\treturn persistTags(el);\n\t\t}\n\t\tif (typeof persistTags === 'string' && persistTags.length > 0) {\n\t\t\treturn el.matches(persistTags);\n\t\t}\n\t\treturn Boolean(persistTags);\n\t}\n}\n"],"names":["n","r","String","split","map","parseInt","concat","slice","join","e","every","t","s","match","o","i","localeCompare","numeric","shouldManageTag","el","localName","matches","compareTags","oldTag","newTag","outerHTML","getAttributes","filters","all","Array","from","attributes","length","filter","_ref","name","some","pattern","RegExp","test","isStylesheet","Plugin","constructor","options","super","_this","this","requires","swup","defaults","persistTags","persistAssets","awaitAssets","timeout","updateHead","visit","newDocument","to","document","removed","added","currentHead","newHead","_temp","shouldPersist","currentTags","children","newChildren","addTags","currentEls","reduce","tags","index","currentEl","push","removeTags","newEls","newEl","getTagsToRemove","reverse","_ref2","forEach","_ref3","removeChild","_ref4","_ref5","insertBefore","cloneNode","_ref6","_ref7","mergeHeadContents","head","isPersistentTag","log","target","source","keep","Set","value","setAttribute","add","has","removeAttribute","updateAttributes","documentElement","_temp2","assetLoadPromises","timeoutMs","element","whenLoaded","cb","sheet","setTimeout","Promise","resolve","waitForStylesheet","then","reject","mount","before","Boolean"],"mappings":"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"}